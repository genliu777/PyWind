# -*- coding: utf-8 -*-
"""
Created on Fri Jun 03 14:41:30 2016
@author: 苑广山
@Email: yuanguangshan@163.com
 
本模块实现如下功能：
1、由用户通过键盘输入edb指标的id（不带前缀s),可输入任意多个edb指标，提取数据到指定的csv文件；
2、用户也可用excel一次性导出多个edb指标的id，并复制到剪切贴上，模块会自动提取代码并取数据；
3、输入截止日期由用户输入，如果不输入，采用默认值,起始日期为20120317，结束日期为20160602;
 
"""
 
import pandas as pd
import numpy as np
import datetime,time
import win32clipboard as wc
import win32con
import re
 
from WindPy import *
from pandas import Series,DataFrame
 
w.start()#启动wind接口
 
#如果用户不输入任何指标，则用这个默认指标提取数据
#如果用户不输入起始时间，则设置默认时间为s
#如果用户不输入起始时间，则设置默认时间为e
#e=datetime.datetime.now().strftime('%y-%m-%d')
 
def windCode():
'''
取得用户输入的edb指标代码，并组合为一个多指标字符串，用于通过wind python接口提取数据
'''
    codes=[]
    c='s5707135'
    while True:
        edb_code=raw_input(r"EDB code(pess 'q' to quit):")
        if edb_code <> "" and edb_code <> 'q':
            edb_code='s'+ edb_code
            codes.append(edb_code)
        elif edb_code=='q':
            break
        else:
            pass
    codes=','.join(codes)
    if codes:
        return codes
    else:
        codes=c
        return codes
 
def getCodeFromClipboard():
'''
通过剪切板获得用户复制到剪切板上的edb代码，利用这些代码来调用接口获取数据
'''
wc.OpenClipboard()
    d = wc.GetClipboardData(win32con.CF_TEXT)
    wc.CloseClipboard()
    codes=re.findall('[SM]+\d{7}',str(d))
    return codes
 
 
def start_date():
'''
获得用户输入的开始日期
'''
    s='20120317'
    start_date=raw_input(r"Start date:")
    if start_date == "":
        start_date=s
        return start_date
    else:
        return start_date
 
def end_date():
'''
获得用户输入的结束日期
'''
    e='20160602'
    end_date=raw_input(r"End date:")
    if end_date == "":
        end_date=e
        return end_date
    else:
       return end_date
 
 
def edb2csv(codes,start_date,end_date):
'''
通过windpy的接口获得数据，并用pandas处理数据并另存为csv文件
'''
 
    data=w.edb(codes,start_date,end_date,"Fill=Previous")
    datachg=[d.strftime('%y-%m-%d') for d in data.Times]
    edb=DataFrame(data.Data,index=data.Codes,columns=datachg).T
    filenamestr=datetime.now().strftime('%y%m%d_%H%M%S')
    print edb
    edb.to_csv(r"C:\Users\gsyuan\Desktop\Wind Data\\"+filenamestr+".csv")#这里还需要优化一下
 
 
 
if __name__ =='__main__':
'''
测试代码1：用户输入代码
'''
    print '请按要求从键盘输入数据：'
    code=windCode()
    start=start_date()
    end=end_date()
    print '-'*20
    edb2csv(code,start,end)
    print '-'*20
 
'''
测试代码2：剪切板取代码时
'''
    print '请将需要提取的代码复制到剪切板上，然后按要求输入数据：'
    code=getCodeFromClipboard()
    start=start_date()
    end=end_date()
    print '-'*20
    edb2csv(code,start,end)
 
 
 

